{#
/**
 * @file
 * Theme override to display a menu.
 *
 * Available variables:
 * - menu_name: The machine name of the menu.
 * - items: A nested list of menu items. Each menu item contains:
 *   - attributes: HTML attributes for the menu item.
 *   - below: The menu item child items.
 *   - title: The menu link title.
 *   - url: The menu link url, instance of \Drupal\Core\Url
 *   - localized_options: Menu link localized options.
 *   - is_expanded: TRUE if the link has visible children within the current
 *     menu tree.
 *   - is_collapsed: TRUE if the link has children within the current menu tree
 *     that are not currently visible.
 *   - in_active_trail: TRUE if the link is in the active trail.
 */
#}
{% import _self as menus %}

{#
  We call a macro which calls itself to render the full tree.
  @see https://twig.symfony.com/doc/1.x/tags/macro.html
#}
{{ menus.menu_links(items, attributes, 0) }}

{% macro menu_links(items, attributes, menu_level) %}
	{% import _self as menus %}
	{% if items %}
		{% if menu_level == 0 %}
			<ul{{attributes.addClass('mag-menu__menu')}}>
		{% else %}
			<ul class="mag-submenu__menu">
		{% endif %}

      {% for item in items %}
        {% set item_title_class = item.title|clean_class|replace({"-" : ""}) %}
        {% set item_title = item.title %}
        {% set classes = [
          'menu-item',
          item.is_expanded ? 'menu-item--expanded',
          item.is_collapsed ? 'menu-item--collapsed',
          item.is_expanded or item.is_collapsed ? 'dropdown-menu-parent',
          item.in_active_trail ? 'menu-item--active-trail',
          menu_level == 0 and item.is_expanded ? 'mag-menu__submenu-wrapper',
          menu_level > 0 ? 'mag-submenu__item' : 'mag-menu__item mag-menu__item--' ~ item_title_class ,
        ] %}
        {% set expanded = "false" %} {# setting aria-expanded attribute value #}

        {# Add aditional class to the links of dropdown menues #}
        <li{{item.attributes.addClass(classes)}}>
          {# Top level menu item that is not a link #}
          {% if menu_level == 0 and item.url.isrouted and item.url.routeName == '<nolink>' %}
            <h2 class="mag-menu__no-link" aria-controls="aria-{{ item_title_class }}" aria-expanded={{expanded}}>
              {{ item_title }}
            </h2>
          {% else %}
            {# Menu item is a link #}
            {{ link(item.title, item.url, { 'class':[(menu_level > 0) ? 'mag-menu__link mag-submenu__link' : 'mag-menu__link mag-menu__link--alt' ]}) }}
          {% endif %}

            {# START. LEVEL-0/LEVEL-1 SUBMENU PANEL #}
            {% if item.below and item.title != 'Search' %}
              <div id="aria-{{ item_title_class }}" class="mag-submenu mag-submenu--{{ menu_level }}" data-level="level-{{ menu_level }}">
                {# submenu links #}
                {{ menus.menu_links(item.below, attributes, menu_level + 1) }}
              </div>
            {% endif %}
            {# END. LEVEL-0/LEVEL-1 SUBMENU PANEL #}
          </li>
        {% endfor %}
        {% if menu_level == 0 %}
          <div class="menu-top-level__item">
            <a href="https://ucsf.edu/news" class="mag-menu-external__ucsf--menu">Visit UCSF News Center<span class="ext" aria-label="(link is external)"></span>
            </a>
          </div>
        {% endif %}
					{# Desctop Search #}
					{# <li id="global-search-dropdown" class="menu-top-level__item menu-top-level__search-item">
														        <button class="main-navigation__search-icon main-navigation__search-icon--desktop">
														          <div>
														            <span class="visually-hidden">Open</span>
														            <span class="visually-hidden">Close</span>
														            <span class="hide-mobile">Search</span>
														          </div>
														        </button>
														      </li> #}
				</ul>
		{% endif %}
	{% endmacro %}
